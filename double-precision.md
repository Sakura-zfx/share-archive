# åŒç²¾åº¦æµ®ç‚¹æ•°
## å…ˆè¯•ä¸€è¯•ï¼Œæ€è€ƒä»¥ä¸‹å‡ ä¸ªä¾‹å­çš„å€¼

```js
0.1 + 0.2 === 0.3 // ?
8.7 * 100 === 870 // ?
(1005 / 1000).toFixed(2) // ?
9007199254740991 > 9007199254740990.6 // ?
9007199254740991 > 9007199254740990.5 // ?
```

## ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™äº›æƒ…å†µï¼Ÿ

JavaScriptä¸­çš„æ•°å­—ï¼ˆBigInté™¤å¤–ï¼‰ä¸ç®¡æ˜¯æ•´æ•°è¿˜æ˜¯æµ®ç‚¹æ•°ï¼Œéƒ½æ˜¯æŒ‰ç…§ [IEEE 754åŒç²¾åº¦æµ®ç‚¹æ•°æ ¼å¼](https://en.wikipedia.org/wiki/Double-precision_floating-point_format) å­˜åœ¨è®¡ç®—æœºä¸­çš„ã€‚  
æ•°å­—ä¼šè½¬æˆäºŒè¿›åˆ¶çš„ç§‘å­¦è®¡æ•°æ³•ï¼ˆ$1 * 2^{E-2013} + M$ ï¼‰ï¼Œå­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/27d68ce0a1f740c1b4e95950c8cb06e8~tplv-k3u1fbpfcp-watermark.image?)

- **Sign** å­˜å‚¨ ç¬¦å·ä½ï¼ˆ1ä½ã€‚0ä»£è¡¨æ•´æ•°ï¼Œ1ä»£è¡¨è´Ÿæ•°ï¼‰
- **Exponent** å­˜å‚¨ æŒ‡æ•°ä½ï¼ˆ11ä½ï¼‰ï¼Œå› ä¸ºç§‘å­¦è®¡æ•°æ³•ä¸­å­˜åœ¨è´Ÿæ•°ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨[åç è§„åˆ™](https://en.wikipedia.org/wiki/Exponent_bias)è¿›è¡Œå¤„ç†ã€‚å³11ä½äºŒè¿›åˆ¶æœ€å¤§å€¼2047ï¼Œæ­£è´Ÿæ•°å„ä½¿ç”¨ä¸€åŠã€‚ä»¥1023ä¸ºä¸­é—´ä½ï¼Œåˆ™è®¡ç®—è§„åˆ™ä¸º Exponent - 1023 = ç§‘å­¦è®¡æ•°æ³•çš„æŒ‡æ•°å€¼
- **Mantissa** å­˜å‚¨ å°¾æ•°ä½ (æ˜¾ç¤ºå­˜å‚¨52ä½ï¼Œå®é™…å¯ä»¥è¡¨ç¤º53ä½)

### ç‰¹æ®Šå€¼
å½“ E = 2047 ï¼ˆå³11ä½æŒ‡æ•°å…¨ä¸º1ï¼‰æ—¶
- å¦‚æœ M ä¸å…¨ä¸º 0ï¼Œåˆ™è¡¨ç¤º NaN
- å¦‚æœ S ä¸º 0ï¼ŒM å…¨ä¸º 0ï¼Œè¡¨ç¤º +Infinity
- å¦‚æœ S ä¸º 1ï¼ŒM å…¨ä¸º 1ï¼Œè¡¨ç¤º -Infinity

å½“ E = 0 ï¼ˆå³11ä½æŒ‡æ•°å…¨ä¸º0ï¼‰æ—¶
- å¦‚æœ S ä¸º 0ï¼Œè¡¨ç¤º +0
- å¦‚æœ S ä¸º 1ï¼Œè¡¨ç¤º -0

æ‰€ä»¥ `Math.pow(2, 1024) === Infinity`

### èˆå…¥è§„åˆ™

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/be54f2a3bc234635a02cfc5a6110e08f~tplv-k3u1fbpfcp-watermark.image?)

æŒ‰ç…§æè¿°ï¼Œå¯¹è¶…å‡ºç²¾åº¦ä½ç½®çš„å¤„ç†æˆ‘çš„ç†è§£æ˜¯ï¼š  
ä»¥ä¿ç•™ç²¾åº¦ 10 ä½ä¸ºä¾‹å­ğŸŒ°
- å¦‚æœ 11 ä½ä¸º 1 ä¸” 11 ä½åé¢çš„éƒ½ä¸º 0 ï¼Œæ­¤æ—¶å‘ä¸Šèˆå…¥å’Œå‘ä¸‹èˆå¼ƒçš„ç²¾åº¦éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆå°±ä¼šå»åˆ¤æ–­ 10 ä½æ˜¯ 0 è¿˜æ˜¯ 1ã€‚å¦‚æœ 10 ä½æ˜¯ 0 ä»£è¡¨å¶æ•°ï¼Œåˆ™èˆå¼ƒï¼›å¦‚æœ 10 ä½æ˜¯ 1ï¼Œåˆ™èˆå…¥
- å¦‚æœ 11 ä½ä¸º 1 ä¸” 11 ä½åé¢çš„ä¸éƒ½ä¸º 0 ï¼Œé‚£ä¹ˆæ­¤æ—¶å‘ä¸Šèˆå…¥çš„ç²¾åº¦ä¼šæ›´é«˜ï¼Œæ‰€ä»¥ä¼šè¿›è¡Œèˆå…¥
- å¦‚æœ 11 ä½ä¸º 0 ï¼Œæ­¤æ—¶è·ç¦» 10 ä½å‘ä¸‹èˆå¼ƒçš„ç²¾åº¦æ¯”å‘ä¸Šèˆå…¥çš„ç²¾åº¦é«˜ï¼Œæ‰€ä»¥ä¼šç›´æ¥èˆå¼ƒ 11 ä½ä»¥åŠåé¢çš„ä½

## çŸ¥è¯†ç‚¹
1. ä¸ºä»€ä¹ˆæœ€å¤§å®‰å…¨æ•´æ•°æ˜¯ æ­£è´Ÿ `Math.pow(2, 53) - 1` ï¼Ÿ
>- $2^{53}$ è½¬æ¢æˆäºŒè¿›åˆ¶ä¸ºï¼š$1\underbrace{0000...000}_{53ä¸ª0}$
>- è¿™ä¸ªå€¼è½¬ç§‘å­¦è®¡æ•°æ³•åå­˜å…¥è®¡ç®—æœºä¸­ä¼šèˆå¼ƒæœ€åä¸€ä¸ª 0
>- $2^{53} + 1$ è½¬æ¢æˆäºŒè¿›åˆ¶ä¸ºï¼š$1\underbrace{0000...000}_{52ä¸ª0}1$  
>- è¿™ä¸ªå€¼è½¬ç§‘å­¦è®¡æ•°æ³•åå­˜å…¥è®¡ç®—æœºä¸­ä¼šèˆå¼ƒæœ€åä¸€ä¸ª 1
>M ä½æœ€å¤§å­˜å‚¨ 52 ä½ï¼Œæ‰€ä»¥ 52 ä½åé¢çš„ä¼šæŒ‰ç…§è§„åˆ™è¿›è¡Œèˆå…¥  
æˆ–è€…å¯ä»¥è¿™æ ·ç†è§£  
>å› ä¸ºå°¾æ•°ä½ç½®æœ€å¤§èƒ½å­˜ä¸‹ 52 ä¸ª1ï¼ŒåŠ ä¸Šç§‘å­¦è®¡æ•°æ³•çš„æ•´æ•°ä½1ï¼Œåˆ™ä¸€å…±æœ‰ 53 ä¸ª1ï¼Œå³ `Math.pow(2, 53) - 1`ã€‚  
2. ä¸ºä»€ä¹ˆ 0.1 + 0.2 === 0.30000000000000004 ä¼šå­˜åœ¨ç²¾åº¦ä¸¢å¤±ï¼Œè€Œ 0.2 + 0.2 === 0.4 æ²¡æœ‰ç²¾åº¦ä¸¢å¤±ï¼Ÿ
ç»´åŸºä¸Šçš„ä¸€ä¸ªè§£é‡Š
![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8b7850cb6be94c84aaddb6cf6f9dda6c~tplv-k3u1fbpfcp-watermark.image?)

```js
(0.1 + 0.2).toPrecision(17) // 0.30000000000000004
// 0.010011001100110011001100110011001100110011001100110101 (0.30000000000000004)
// 0.0100110011001100110011001100110011001100110011001101 (0.3)

(0.2 + 0.2).toPrecision(17) // 0.40000000000000002
// 0.01100110011001100110011001100110011001100110011001101 (0.40000000000000002)
// 0.01100110011001100110011001100110011001100110011001101 (0.4)
```
3. å¦‚ä½•å¤„ç†ç²¾åº¦ä¸¢å¤±ï¼Ÿ
æå‡ºä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼š
- å¦‚æœåªæ¶‰åŠæ•´æ•°çš„è¿ç®—ï¼Œåˆ™å¯ä»¥è½¬æˆ BigInt ç±»å‹è¿›è¡Œè®¡ç®—
- å¦‚æœæ¶‰åŠå°æ•°çš„è¿ç®—ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ toPrecision æˆ–è€…è½¬æ¢æˆæ•´æ•°å†è®¡ç®—
- å–„ç”¨å·¥å…· [number-precision](https://github.com/nefe/number-precision)    / [lodash round](https://www.lodashjs.com/docs/lodash.round)

## å‚è€ƒ
> https://en.wikipedia.org/wiki/IEEE_754  ç»´åŸºä¸Šå…³äº IEEE-754 çš„ä»‹ç»  
> https://en.wikipedia.org/wiki/Double-precision_floating-point_format  ç»´åŸºä¸Šå…³äº åŒç²¾åº¦æµ®ç‚¹æ•°çš„ä»‹ç»  
> https://github.com/camsong/blog/issues/9  github çš„è®¨è®ºï¼ŒæŒºè¯¦ç»†çš„  
> https://zhuanlan.zhihu.com/p/66949640  

## è½¬æ¢å·¥å…·
> https://tool.oschina.net/hexconvert/ åœ¨çº¿è¿›åˆ¶è½¬æ¢  
> http://www.binaryconvert.com/result_double.html  å¯è§†åŒ–åŒç²¾åº¦å­˜å‚¨æ ¼å¼
